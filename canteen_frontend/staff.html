<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff - Orders Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- NAVBAR -->
  <header class="bg-white shadow-md">
    <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
      <div>
        <span class="text-xl font-bold text-blue-600">Automated Canteen</span>
        <span class="text-xs text-gray-500 ml-1">Staff Panel</span>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-sm text-gray-700">
          Staff: <span id="staffName" class="font-semibold">Staff</span>
        </span>
        <button id="logoutBtn"
          class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">All Orders</h2>
      <div class="flex items-center gap-2 text-sm">
        <label for="statusFilter">Filter:</label>
        <select id="statusFilter" class="border rounded px-2 py-1">
          <option value="all">All</option>
          <option value="Placed">Placed</option>
          <option value="Accepted">Accepted</option>
          <option value="Preparing">Preparing</option>
          <option value="Ready">Ready</option>
          <option value="Completed">Completed</option>
        </select>
      </div>
    </div>

    <div id="ordersContainer" class="space-y-4">
      <!-- orders go here -->
    </div>
  </main>

  <!-- TOAST -->
  <div id="toast"
       class="hidden fixed bottom-4 right-4 bg-black text-white text-sm px-4 py-2 rounded-lg opacity-90">
    Updated
  </div>

  <script>
    // ---- AUTH CHECK ----
    const staffUser = JSON.parse(localStorage.getItem("canteenUser"));
    if (!staffUser || staffUser.role !== "staff") {
      window.location.href = "login.html";
    }
    document.getElementById("staffName").textContent = staffUser.name || "Staff";

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.remove("hidden");
      setTimeout(() => t.classList.add("hidden"), 1500);
    }

    function statusClass(status) {
      if (status === "Placed") return "bg-yellow-100 text-yellow-700";
      if (status === "Accepted") return "bg-blue-100 text-blue-700";
      if (status === "Preparing") return "bg-purple-100 text-purple-700";
      if (status === "Ready") return "bg-green-100 text-green-700";
      if (status === "Completed") return "bg-gray-200 text-gray-800";
      return "bg-gray-100 text-gray-700";
    }

    function formatDate(isoStr) {
      const d = new Date(isoStr);
      return d.toLocaleString();
    }

    function loadOrders(filter = "all") {
      fetch("http://127.0.0.1:5000/api/staff/orders")
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            alert("Error loading orders");
            return;
          }
          renderOrders(data.orders, filter);
        })
        .catch(err => {
          console.error(err);
          alert("Could not load orders from backend");
        });
    }

    function renderOrders(orders, filter) {
      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

      let list = orders.slice().sort((a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt)
      );

      if (filter !== "all") {
        list = list.filter(o => o.status === filter);
      }

      if (list.length === 0) {
        container.innerHTML = "<p class='text-sm text-gray-600'>No orders found.</p>";
        return;
      }

      list.forEach(order => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4 border";

        card.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="text-sm text-gray-500">Order ID</div>
              <div class="font-semibold">${order.id}</div>
              <div class="text-xs text-gray-500 mt-1">User: ${order.userEmail}</div>
              <div class="text-xs text-gray-500">Placed: ${formatDate(order.createdAt)}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-500 mb-1">Status</div>
              <span class="inline-block text-xs px-3 py-1 rounded-full ${statusClass(order.status)}">
                ${order.status}
              </span>
            </div>
          </div>

          <div class="mt-3">
            <div class="text-sm text-gray-500 mb-1">Items</div>
            <ul class="list-disc list-inside text-sm text-gray-700">
              ${order.items.map(it => `
                <li>${it.name} x ${it.qty} (₹${it.price} each)</li>
              `).join("")}
            </ul>
          </div>

          <div class="mt-3 flex justify-between items-center">
            <div class="text-sm text-gray-500">Total</div>
            <div class="font-bold">₹${order.total}</div>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <span class="text-sm text-gray-500">Update Status:</span>
            <select class="statusSelect border rounded px-2 py-1 text-sm"
              data-id="${order.id}">
              <option value="Placed" ${order.status === "Placed" ? "selected" : ""}>Placed</option>
              <option value="Accepted" ${order.status === "Accepted" ? "selected" : ""}>Accepted</option>
              <option value="Preparing" ${order.status === "Preparing" ? "selected" : ""}>Preparing</option>
              <option value="Ready" ${order.status === "Ready" ? "selected" : ""}>Ready</option>
              <option value="Completed" ${order.status === "Completed" ? "selected" : ""}>Completed</option>
            </select>
          </div>
        `;

        container.appendChild(card);
      });

      document.querySelectorAll(".statusSelect").forEach(sel => {
        sel.addEventListener("change", () => {
          const orderId = sel.getAttribute("data-id");
          const newStatus = sel.value;
          updateOrderStatus(orderId, newStatus);
        });
      });
    }

    function updateOrderStatus(orderId, status) {
      fetch("http://127.0.0.1:5000/api/staff/orders/" + orderId + "/status", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      })
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            alert("Error updating status: " + data.message);
            return;
          }
          showToast("Order " + orderId + " → " + status);
          loadOrders(document.getElementById("statusFilter").value);
        })
        .catch(err => {
          console.error(err);
          alert("Could not update order status");
        });
    }

    // ---- EVENTS ----
    document.getElementById("statusFilter").addEventListener("change", () => {
      const filter = document.getElementById("statusFilter").value;
      loadOrders(filter);
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      if (confirm("Logout from staff account?")) {
        window.location.href = "login.html";
      }
    });

    // ---- INIT ----
    loadOrders("all");
  </script>

</body>
</html>
