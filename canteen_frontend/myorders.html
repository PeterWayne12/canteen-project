<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders - Automated Canteen</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- NAVBAR -->
  <header class="bg-white shadow-md">
    <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="text-xl font-bold text-blue-600">Automated Canteen</span>
        <span class="text-xs text-gray-500">My Orders</span>
      </div>

      <div class="flex items-center gap-4">
        <span class="text-sm text-gray-700">
          User: <span id="userName" class="font-semibold">User</span>
        </span>

        <button id="menuBtn"
          class="text-sm bg-gray-100 border px-3 py-1 rounded hover:bg-gray-200">
          Menu
        </button>

        <button id="statusBtn"
          class="text-sm bg-gray-100 border px-3 py-1 rounded hover:bg-gray-200">
          Latest Status
        </button>

        <button id="logoutBtn"
          class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto px-4 py-6">
    <h2 class="text-xl font-semibold mb-4">Your Orders</h2>

    <div id="noOrderMsg" class="bg-white border rounded p-4 text-sm text-gray-600 hidden">
      You have not placed any orders yet.
      <button id="goToMenu" class="text-blue-600 underline ml-1">Go to menu</button>
    </div>

    <div id="ordersList" class="space-y-4">
      <!-- Order cards will be injected here -->
    </div>
  </main>

  <script>
    // ---- AUTH CHECK ----
    const savedUser = JSON.parse(localStorage.getItem("canteenUser"));
    if (!savedUser || savedUser.role !== "user") {
      window.location.href = "login.html";
    }
    document.getElementById("userName").textContent = savedUser.name || "User";

    // ---- HELPERS ----
    function statusClass(status) {
      if (status === "Placed") return "bg-yellow-100 text-yellow-700";
      if (status === "Accepted") return "bg-blue-100 text-blue-700";
      if (status === "Preparing") return "bg-purple-100 text-purple-700";
      if (status === "Ready") return "bg-green-100 text-green-700";
      if (status === "Completed") return "bg-gray-200 text-gray-800";
      return "bg-gray-100 text-gray-700";
    }

    function formatDate(isoStr) {
      const d = new Date(isoStr);
      return d.toLocaleString();
    }

    function loadMyOrders() {
      fetch("http://127.0.0.1:5000/api/myorders?email=" + encodeURIComponent(savedUser.email))
        .then(res => res.json())
        .then(data => {
          const noOrderMsg = document.getElementById("noOrderMsg");
          const container = document.getElementById("ordersList");

          if (!data.success || !data.orders || data.orders.length === 0) {
            noOrderMsg.classList.remove("hidden");
            container.innerHTML = "";
            return;
          }

          noOrderMsg.classList.add("hidden");
          container.innerHTML = "";

          const orders = data.orders.slice().sort((a, b) =>
            new Date(b.createdAt) - new Date(a.createdAt)
          );

          orders.forEach(order => {
            const card = document.createElement("div");
            card.className = "bg-white rounded-lg shadow p-4 border";

            card.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <div class="text-sm text-gray-500">Order ID</div>
                  <div class="font-semibold">#${order.id}</div>
                  <div class="text-xs text-gray-500 mt-1">
                    Placed on: ${formatDate(order.createdAt)}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-gray-500 mb-1">Status</div>
                  <span class="inline-block text-xs px-3 py-1 rounded-full ${statusClass(order.status)}">
                    ${order.status}
                  </span>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-sm text-gray-500 mb-1">Items</div>
                <ul class="list-disc list-inside text-sm text-gray-700">
                  ${order.items.map(it => `
                    <li>${it.name} x ${it.qty} (₹${it.price} each)</li>
                  `).join("")}
                </ul>
              </div>

              <div class="mt-3 flex justify-between items-center">
                <div class="text-sm text-gray-500">Total Amount</div>
                <div class="font-bold">₹${order.total}</div>
              </div>
            `;

            container.appendChild(card);
          });
        })
        .catch(err => {
          console.error(err);
          alert("Could not load your orders from server.");
        });
    }

    // ---- NAV BUTTONS ----
    document.getElementById("menuBtn").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    document.getElementById("statusBtn").addEventListener("click", () => {
      window.location.href = "order_status.html";
    });

    document.getElementById("goToMenu").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      if (confirm("Logout from this account?")) {
        window.location.href = "login.html";
      }
    });

    // ---- INITIAL LOAD ----
    loadMyOrders();
  </script>

</body>
</html>
